<!DOCTYPE html>
<html class="light" lang="th">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>‡∏™‡∏≤‡∏ò‡∏∏ - ‡∏Ç‡∏≠‡∏á‡∏ñ‡∏ß‡∏≤‡∏¢‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° (Connected Edition)</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;family=Noto+Serif+Thai:wght@400;700&amp;family=Charm:wght@400;700&amp;family=Noto+Sans+Thai:wght@300;400;500;600&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    
    <!-- Leaflet for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzN8p1bt_HUHaY1hTjaWypxekf5xos_pWXNi6yYOcQYoNW5vp16f4ln9xBvWJrroPWI/exec"; // üî¥ ‡∏ß‡∏≤‡∏á URL ‡∏Ç‡∏≠‡∏á Google Apps Script (/exec) ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà

        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#8B2222", 
                        "sathu-gold": "#C5A059", 
                        "sathu-gold-light": "#E8D5B5",
                        "silk-bg": "#F4EFE9",
                    },
                    fontFamily: {
                        "display": ["Inter", "Noto Sans Thai", "sans-serif"],
                        "serif": ["Noto Serif Thai", "serif"],
                        "logo": ["Charm", "serif"],
                    }
                },
            },
        }
    </script>
    
    <style>
        .silk-texture {
            background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png');
            background-attachment: fixed;
        }
        
        .glass-premium {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(25px);
            border: 1.5px solid rgba(197, 160, 89, 0.4);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.1);
        }
        .dark .glass-premium {
            background: rgba(26, 20, 20, 0.95);
            border: 1.5px solid rgba(197, 160, 89, 0.3);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #slider-knob {
            transition: transform 0.1s ease-out;
            background: linear-gradient(135deg, #C5A059 0%, #8B2222 100%);
        }

        @keyframes subtle-float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-12px) rotate(1deg); }
        }
        .animate-float { animation: subtle-float 10s ease-in-out infinite; }

        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            background-size: 200% 100%;
            animation: shimmer 3s infinite linear;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .font-logo-style { font-family: 'Charm', serif; }
        .transition-all-custom { transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        #delivery-map { height: 400px; width: 100%; border-radius: 2.5rem; border: 2px solid #C5A059; z-index: 10; }

        .btn-glow {
            box-shadow: 0 0 20px rgba(197, 160, 89, 0.4);
            animation: pulse-gold 2s infinite;
        }
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(197, 160, 89, 0.5); }
            70% { box-shadow: 0 0 0 15px rgba(197, 160, 89, 0); }
            100% { box-shadow: 0 0 0 0 rgba(197, 160, 89, 0); }
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
        }
        .toast-active { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body class="silk-texture transition-all-custom bg-[#F4EFE9] dark:bg-[#0F0A0A] font-sans text-[#1b0d11] dark:text-stone-200 min-h-screen overflow-x-hidden select-none">

    <div id="app" class="max-w-md mx-auto min-h-screen relative shadow-[0_0_150px_rgba(0,0,0,0.1)] bg-white/20 dark:bg-black/20">
        
        <!-- TOP NAVIGATION -->
        <div class="fixed top-6 left-6 right-6 z-[60] flex justify-between items-center pointer-events-none">
            <div class="pointer-events-auto">
                <button onclick="toggleTheme()" class="w-12 h-12 rounded-full glass-premium flex items-center justify-center active:scale-90 transition-all shadow-lg border border-sathu-gold/30">
                    <span id="theme-icon" class="material-symbols-outlined text-sathu-gold text-2xl font-light">dark_mode</span>
                </button>
            </div>
            <div class="pointer-events-auto">
                <button onclick="showAdminLogin()" class="w-12 h-12 rounded-full glass-premium flex items-center justify-center active:scale-90 transition-all shadow-lg border border-sathu-gold/30">
                    <span class="material-symbols-outlined text-stone-400 text-2xl font-light">admin_panel_settings</span>
                </button>
            </div>
        </div>

        <!-- SCREEN 1: IMMERSIVE EXPLORE -->
        <div id="home-screen" class="transition-all-custom">
            <div class="relative h-[90vh] w-full overflow-hidden">
                <div class="absolute inset-0 bg-cover bg-center scale-110 animate-float" 
                     style="background-image: url('https://images.unsplash.com/photo-1508608226934-2e928286a1df?q=80&w=1200&auto=format&fit=crop');">
                    <div class="absolute inset-0 bg-gradient-to-b from-black/40 via-transparent to-[#F4EFE9] dark:to-[#0F0A0A]"></div>
                </div>
                
                <div class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center pointer-events-none">
                    <div class="bg-primary px-16 py-14 rounded-[4.5rem] border-[4px] border-sathu-gold shadow-[0_40px_100px_-20px_rgba(0,0,0,0.6)]">
                        <h1 class="font-logo-style text-[110px] text-sathu-gold-light leading-none mb-3">‡∏™‡∏≤‡∏ò‡∏∏</h1>
                        <div class="w-24 h-[1px] bg-sathu-gold/40 mx-auto my-3"></div>
                        <p class="text-sathu-gold-light text-[10px] tracking-[0.8em] uppercase font-bold opacity-80">Digital Nirvana</p>
                    </div>
                </div>
                <div class="absolute bottom-16 left-0 right-0 flex flex-col items-center animate-bounce opacity-40">
                    <span class="text-[10px] uppercase tracking-widest mb-2 font-bold dark:text-stone-400">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏°</span>
                    <span class="material-symbols-outlined font-light dark:text-stone-400">expand_more</span>
                </div>
            </div>

            <div class="px-8 mb-20">
                <div class="flex items-center gap-4 mb-10 border-b border-sathu-gold/30 pb-4">
                    <div class="w-1.5 h-10 bg-primary dark:bg-sathu-gold rounded-full"></div>
                    <div>
                        <h2 class="text-3xl font-logo-style font-bold tracking-tight text-primary dark:text-sathu-gold-light">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h2>
                        <p class="text-[10px] text-stone-400 uppercase tracking-widest font-bold">Sacred Spaces</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-4 grid-rows-2 gap-5 h-[420px]">
                    <div class="col-span-2 row-span-2 relative rounded-[4rem] overflow-hidden shadow-2xl active:scale-95 transition-all duration-500 border-2 border-white dark:border-stone-800" onclick="scrollToSelection()">
                        <img src="https://images.unsplash.com/photo-1560731215-68046835151b?q=80&w=600" class="absolute inset-0 h-full w-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                        <div class="absolute bottom-8 left-8 text-white">
                            <p class="text-[11px] font-bold uppercase tracking-[0.2em] text-sathu-gold-light mb-2">Temple</p>
                            <p class="text-3xl font-logo-style leading-tight">‡∏ä‡∏∏‡∏î‡∏ñ‡∏ß‡∏≤‡∏¢‡∏ß‡∏¥‡∏à‡∏¥‡∏ï‡∏£</p>
                        </div>
                    </div>
                    <div class="col-span-2 row-span-1 relative rounded-[3rem] overflow-hidden shadow-xl active:scale-95 transition-all duration-500 border-2 border-white dark:border-stone-800">
                        <img src="https://images.unsplash.com/photo-1566996694954-90b052c413c4?q=80&w=600" class="absolute inset-0 h-full w-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                        <div class="absolute bottom-6 left-8 text-white">
                            <p class="text-[11px] font-bold uppercase tracking-[0.2em] text-sathu-gold-light mb-1">Ritual</p>
                            <p class="text-2xl font-logo-style">‡∏°‡∏≤‡∏•‡∏±‡∏¢‡∏£‡πà‡∏ß‡∏°‡∏™‡∏°‡∏±‡∏¢</p>
                        </div>
                    </div>
                    <div class="col-span-1 row-span-1 relative rounded-[2.5rem] bg-white dark:bg-stone-900 flex items-center justify-center border-2 border-sathu-gold shadow-lg transition-all">
                        <span class="material-symbols-outlined text-primary dark:text-sathu-gold text-4xl font-light">auto_awesome</span>
                    </div>
                    <div class="col-span-1 row-span-1 relative rounded-[2.5rem] bg-primary flex items-center justify-center shadow-[0_15px_30px_rgba(139,34,34,0.4)] border-2 border-sathu-gold">
                        <span class="material-symbols-outlined text-sathu-gold-light text-4xl font-light">spa</span>
                    </div>
                </div>
            </div>

            <div class="px-8 mb-40" id="selection-area">
                <div class="flex items-center justify-between mb-12">
                    <div>
                        <h2 class="text-4xl font-logo-style font-bold tracking-tight text-primary dark:text-sathu-gold-light">‡∏†‡∏≤‡∏ä‡∏ô‡∏∞‡πÅ‡∏´‡πà‡∏á‡πÅ‡∏™‡∏á</h2>
                        <p class="text-[11px] text-stone-400 uppercase tracking-[0.4em] font-bold mt-2">Premium Merit Selections</p>
                    </div>
                    <div class="bg-primary dark:bg-stone-900 px-6 py-3 rounded-full shadow-xl border-2 border-sathu-gold">
                        <span class="text-lg font-bold text-sathu-gold-light">‡∏ø<span id="unit-price-label">10</span></span>
                    </div>
                </div>
                
                <div class="space-y-10" id="user-product-list">
                    <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                </div>
            </div>
        </div>

        <!-- SCREEN 2: CHECKOUT -->
        <div id="checkout-screen" class="hidden transition-all-custom min-h-screen pt-24 px-10 pb-64">
            <button onclick="hideCheckout()" class="mb-14 flex items-center gap-4 text-primary dark:text-stone-400 text-[12px] font-bold uppercase tracking-[0.4em] bg-white dark:bg-stone-900 shadow-xl border-2 border-sathu-gold px-8 py-4 rounded-full w-max hover:scale-105 transition-all">
                <span class="material-symbols-outlined text-sm font-bold">arrow_back_ios_new</span> ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
            </button>
            
            <h2 class="text-[80px] font-logo-style font-bold mb-20 tracking-tighter text-primary dark:text-stone-300 leading-[0.8]">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏ó‡∏¢<br><span class="text-sathu-gold">‡∏ñ‡∏ß‡∏≤‡∏¢‡∏ö‡∏π‡∏ä‡∏≤</span></h2>

            <div class="space-y-24">
                <div id="checkout-list" class="space-y-12"></div>

                <div class="pt-16 border-t-4 border-sathu-gold space-y-16">
                    <div>
                        <h3 class="text-[12px] font-bold uppercase tracking-[0.5em] text-sathu-gold mb-10 border-l-4 border-primary pl-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h3>
                        <div onclick="getLocation()" class="glass-premium p-10 rounded-[4.5rem] flex items-center justify-between active:scale-95 transition-transform cursor-pointer shadow-2xl">
                            <div class="flex items-center gap-8">
                                <div id="gps-icon-container" class="w-20 h-20 rounded-[2.5rem] bg-stone-900 text-sathu-gold flex items-center justify-center shadow-inner transition-colors">
                                    <span id="gps-icon" class="material-symbols-outlined text-4xl font-light">near_me</span>
                                </div>
                                <div>
                                    <p class="text-[11px] uppercase font-bold text-stone-400 tracking-[0.3em] mb-2">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</p>
                                    <p id="gps-status-text" class="text-xl font-bold tracking-tight text-primary dark:text-white">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ä‡∏£‡πå‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-8">
                        <input type="text" id="cust-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" class="bg-white dark:bg-stone-900 border-2 border-sathu-gold/20 rounded-[2rem] px-8 py-6 text-xl focus:ring-4 focus:ring-primary/10 transition-all font-serif">
                        <input type="tel" id="cust-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" class="bg-white dark:bg-stone-900 border-2 border-sathu-gold/20 rounded-[2rem] px-8 py-6 text-xl focus:ring-4 focus:ring-primary/10 transition-all font-serif">
                    </div>

                    <div>
                        <h3 class="text-[12px] font-bold uppercase tracking-[0.5em] text-sathu-gold mb-10 border-l-4 border-primary pl-4">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏à‡∏¥‡∏ï</h3>
                        <div class="glass-premium p-10 rounded-[4.5rem] shadow-2xl">
                            <textarea id="cust-prayer" class="w-full bg-transparent border-none p-0 focus:ring-0 text-2xl italic text-stone-800 dark:text-stone-200 placeholder:text-stone-300 min-h-[220px] resize-none leading-relaxed font-serif" 
                                      placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏à‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-baseline pt-10 border-b-2 border-stone-100 dark:border-stone-800 pb-10">
                    <span class="text-sathu-gold font-bold uppercase tracking-[0.5em] text-xs">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡∏∏‡∏®‡∏•‡πÄ‡∏à‡∏ï‡∏ô‡∏≤</span>
                    <span class="text-[90px] font-bold text-primary dark:text-sathu-gold-light tracking-tighter leading-none">‡∏ø<span id="final-total">0</span></span>
                </div>

                <div class="relative h-36 bg-stone-900 dark:bg-stone-950 rounded-full p-4 overflow-hidden shadow-2xl flex items-center border-4 border-sathu-gold" id="slide-container">
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span class="text-[15px] font-bold text-sathu-gold-light uppercase tracking-[0.7em] animate-pulse">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏ß‡∏≤‡∏¢‡∏ö‡∏∏‡∏ç</span>
                    </div>
                    <div id="slider-knob" class="relative h-28 w-28 rounded-full flex items-center justify-center text-white shadow-2xl cursor-grab active:cursor-grabbing z-10 shimmer">
                        <span class="material-symbols-outlined text-6xl font-thin">keyboard_double_arrow_right</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADMIN SCREENS -->
        <div id="admin-login-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-8 backdrop-blur-3xl bg-black/60">
            <div class="glass-premium w-full max-w-sm p-12 rounded-[4rem] text-center shadow-2xl border-[3px] border-sathu-gold">
                <span class="material-symbols-outlined text-primary text-6xl mb-8">lock_person</span>
                <h3 class="text-4xl font-logo-style font-bold mb-4 tracking-wide text-primary dark:text-sathu-gold">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
                <input type="password" id="admin-pw" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-stone-100 dark:bg-stone-800 border-none rounded-3xl py-6 text-center text-4xl tracking-[0.6em] mb-8 focus:ring-4 focus:ring-primary/20 font-bold">
                <div class="flex gap-4">
                    <button onclick="hideAdminLogin()" class="flex-1 py-5 text-sm font-bold text-stone-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="checkAdminLogin()" class="flex-1 bg-primary text-white py-5 rounded-3xl font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
                <p id="login-error" class="text-red-500 text-[10px] mt-6 font-bold hidden">ACCESS DENIED</p>
            </div>
        </div>

        <div id="admin-screen" class="hidden min-h-screen pt-24 px-10 pb-40 transition-all-custom">
            <div class="flex justify-between items-center mb-16 px-2">
                <div><h2 class="text-5xl font-logo-style font-bold text-primary dark:text-sathu-gold">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h2></div>
                <button onclick="exitAdmin()" class="w-14 h-14 rounded-full bg-stone-100 dark:bg-stone-800 flex items-center justify-center shadow-lg"><span class="material-symbols-outlined text-stone-500">logout</span></button>
            </div>
            <div class="flex gap-10 mb-14 border-b-2 border-stone-100 dark:border-stone-800 px-4">
                <button onclick="switchAdminTab('stock')" id="tab-stock" class="pb-5 admin-tab-active font-bold text-sm uppercase">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                <button onclick="switchAdminTab('map')" id="tab-map" class="pb-5 text-stone-400 font-bold text-sm uppercase">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</button>
            </div>
            <div id="admin-stock" class="space-y-12 animate-in slide-in-from-bottom-5">
                <div class="glass-premium p-10 rounded-[4.5rem] space-y-12" id="admin-product-list">
                    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô -->
                </div>
            </div>
            <div id="admin-map" class="hidden space-y-10">
                <div class="glass-premium p-4 rounded-[3.5rem] shadow-2xl relative overflow-hidden border-2 border-sathu-gold">
                    <div id="delivery-map"></div>
                </div>
                <div class="space-y-6 px-4" id="delivery-list">
                    <h3 class="font-bold text-xl flex items-center gap-3"><span class="material-symbols-outlined text-primary">local_shipping</span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h3>
                </div>
            </div>
        </div>

        <!-- SUCCESS SCREEN -->
        <div id="success-screen" class="hidden fixed inset-0 z-[100] transition-all-custom bg-[#F4EFE9] dark:bg-[#0F0A0A] flex flex-col items-center justify-center text-center p-12">
            <div class="w-64 h-64 bg-primary/5 rounded-full flex items-center justify-center mb-16 relative shadow-premium border-2 border-sathu-gold/20">
                <div class="absolute inset-0 bg-primary/10 rounded-full animate-ping duration-[4s]"></div>
                <span class="material-symbols-outlined text-primary dark:text-sathu-gold text-[150px] font-thin" style="font-variation-settings: 'FILL' 1">spa</span>
            </div>
            <h2 class="text-[120px] font-logo-style font-bold mb-8 text-primary dark:text-sathu-gold leading-none">‡∏≠‡∏ô‡∏∏‡πÇ‡∏°‡∏ó‡∏ô‡∏≤</h2>
            <p class="text-stone-600 dark:text-stone-400 italic font-serif text-3xl">"‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏∏‡∏®‡∏•‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏î‡∏≤‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏™‡∏á‡∏ö ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏°‡∏≤‡∏™‡∏π‡πà‡∏à‡∏¥‡∏ï‡πÉ‡∏à"</p>
            <button onclick="location.reload()" class="bg-stone-900 text-sathu-gold-light px-24 py-10 rounded-full font-bold uppercase text-[13px] shadow-2xl mt-10">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </div>

        <!-- NAV DOCK -->
        <div class="fixed bottom-12 left-1/2 -translate-x-1/2 w-[85%] z-40 transition-all-custom" id="nav-dock">
            <div class="glass-premium rounded-[3.5rem] px-12 py-8 flex justify-between items-center shadow-premium">
                <button onclick="location.reload()" class="text-primary dark:text-sathu-gold active:scale-90 transition-transform"><span class="material-symbols-outlined font-bold text-4xl">home</span></button>
                <button class="text-stone-300 dark:text-stone-700 active:scale-90 transition-transform" onclick="showCheckout()"><span class="material-symbols-outlined font-light text-4xl">shopping_bag</span></button>
                <button onclick="showAdminLogin()" class="text-stone-300 dark:text-stone-700 active:scale-90 transition-transform"><span class="material-symbols-outlined font-light text-4xl">person</span></button>
                <div id="cart-trigger" class="hidden absolute -top-32 left-0 right-0 animate-in slide-in-from-bottom-5 duration-700">
                    <button onclick="showCheckout()" class="w-full bg-stone-900 text-sathu-gold py-8 rounded-full text-[14px] font-bold shadow-[0_40px_80px_rgba(0,0,0,0.4)] flex items-center justify-center gap-8 border-2 border-sathu-gold btn-glow">
                        <span class="font-logo-style text-4xl">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡∏ß‡∏≤‡∏¢‡∏ö‡∏∏‡∏ç</span>
                        <span class="bg-primary text-white px-6 py-2 rounded-full font-sans text-xl">‡∏ø<span id="trigger-total">0</span></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Global Loader -->
        <div id="loading-overlay" class="hidden fixed inset-0 z-[110] bg-white/95 dark:bg-[#0F0A0A]/95 backdrop-blur-3xl flex flex-col items-center justify-center text-center transition-all-custom">
            <div class="size-40 border-[8px] border-stone-100 dark:border-white/10 border-t-primary dark:border-t-sathu-gold rounded-full animate-spin"></div>
            <p id="loading-text" class="mt-16 font-logo-style italic text-primary dark:text-sathu-gold tracking-[0.3em] animate-pulse text-6xl">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏°‡∏ñ‡∏ß‡∏≤‡∏¢‡πÄ‡∏à‡∏ï‡∏ô‡∏≤...</p>
        </div>

        <!-- Custom Toast -->
        <div id="toast" class="toast glass-premium px-8 py-4 rounded-full text-sm font-bold shadow-2xl border-2 border-sathu-gold text-primary">
            <span id="toast-msg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
        </div>

    </div>

    <script>
        // --- DATA STATE ---
        let products = [
            { id: 'lotus', name: '‡∏î‡∏≠‡∏Å‡∏ö‡∏±‡∏ß‡∏®‡∏¥‡∏•‡∏≤‡∏Ç‡∏≤‡∏ß', price: 10, stock: 50, img: 'https://images.unsplash.com/photo-1560731215-68046835151b?q=80&w=400' },
            { id: 'orchid', name: '‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÑ‡∏°‡πâ‡∏°‡πà‡∏ß‡∏á‡∏™‡∏¥‡∏£‡∏¥', price: 10, stock: 30, img: 'https://images.unsplash.com/photo-1566996694954-90b052c413c4?q=80&w=400' }
        ];
        let cart = { lotus: 0, orchid: 0 };
        let userLocation = "";
        let isAdminLoggedIn = false;
        let map;

        // --- THEME ---
        function toggleTheme() {
            const html = document.documentElement;
            html.classList.toggle('dark');
            document.getElementById('theme-icon').innerText = html.classList.contains('dark') ? 'light_mode' : 'dark_mode';
        }

        // --- CORE UI ---
        function init() {
            renderUserProducts();
            renderAdminProducts();
        }

        function renderUserProducts() {
            const container = document.getElementById('user-product-list');
            container.innerHTML = products.map(p => `
                <div class="group relative rounded-[4.5rem] overflow-hidden shadow-2xl active:scale-[0.98] transition-all duration-700 dark:border-2 dark:border-stone-800" onclick="updateQty('${p.id}', 1)">
                    <div class="aspect-[16/11] overflow-hidden">
                        <img src="${p.img}" class="w-full h-full object-cover transition-transform duration-[3s] group-hover:scale-110">
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-black/20 to-transparent"></div>
                    <div id="badge-${p.id}" class="${cart[p.id] > 0 ? '' : 'hidden'} absolute top-8 right-10 bg-white dark:bg-stone-900 text-primary dark:text-sathu-gold w-16 h-16 rounded-full flex items-center justify-center text-3xl font-logo-style shadow-2xl border-[6px] border-sathu-gold animate-in zoom-in duration-300">${cart[p.id]}</div>
                    <div class="absolute bottom-10 left-12 text-white">
                        <h3 class="text-4xl font-logo-style mb-1 text-sathu-gold-light">${p.name}</h3>
                        <p class="text-[11px] opacity-60 uppercase tracking-[0.4em] font-bold">${p.id.toUpperCase()}</p>
                    </div>
                </div>
            `).join('');
            document.getElementById('unit-price-label').innerText = products[0].price;
        }

        function updateQty(id, change) {
            cart[id] = Math.max(0, cart[id] + change);
            renderUserProducts();
            
            const total = Object.keys(cart).reduce((sum, id) => sum + (cart[id] * products.find(p => p.id === id).price), 0);
            const trigger = document.getElementById('cart-trigger');
            document.getElementById('trigger-total').innerText = total;
            
            if (total > 0) trigger.classList.remove('hidden');
            else trigger.classList.add('hidden');

            if (window.navigator.vibrate) window.navigator.vibrate(20);
        }

        // --- NAVIGATION ---
        function scrollToSelection() { document.getElementById('selection-area').scrollIntoView({ behavior: 'smooth' }); }

        function showCheckout() {
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('checkout-screen').classList.remove('hidden');
            document.getElementById('nav-dock').classList.add('hidden');
            renderCheckout();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function hideCheckout() {
            document.getElementById('checkout-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.remove('hidden');
            document.getElementById('nav-dock').classList.remove('hidden');
        }

        function renderCheckout() {
            const list = document.getElementById('checkout-list');
            list.innerHTML = '';
            let total = 0;
            Object.keys(cart).forEach(id => {
                if (cart[id] > 0) {
                    const p = products.find(prod => prod.id === id);
                    total += cart[id] * p.price;
                    list.innerHTML += `
                        <div class="flex items-center justify-between group animate-in slide-in-from-right duration-1000">
                            <div class="flex items-center gap-12">
                                <div class="w-36 h-36 rounded-[4rem] overflow-hidden shadow-2xl border-4 border-white dark:border-stone-800">
                                    <img src="${p.img}" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <p class="font-logo-style font-bold text-5xl tracking-tight text-primary dark:text-stone-100">${p.name}</p>
                                    <p class="text-[13px] text-sathu-gold uppercase tracking-[0.5em] font-bold mt-5">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô x${cart[id]}</p>
                                </div>
                            </div>
                            <p class="font-bold text-5xl tracking-tighter text-primary">‡∏ø${cart[id] * p.price}</p>
                        </div>
                    `;
                }
            });
            document.getElementById('final-total').innerText = total;
        }

        // --- GPS ---
        function getLocation() {
            const statusText = document.getElementById('gps-status-text');
            const iconCont = document.getElementById('gps-icon-container');
            statusText.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        userLocation = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
                        statusText.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS ‡πÅ‡∏•‡πâ‡∏ß";
                        iconCont.classList.replace('bg-stone-900', 'bg-green-600');
                        showToast("‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏•‡πâ‡∏ß");
                    },
                    () => {
                        userLocation = "17.41500, 102.78600 (‡∏à‡∏≥‡∏•‡∏≠‡∏á)";
                        statusText.innerText = "‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡∏ô‡∏Ñ‡∏£‡∏≠‡∏∏‡∏î‡∏£)";
                        showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á GPS ‡πÑ‡∏î‡πâ");
                    }
                );
            }
        }

        // --- ADMIN ---
        function showAdminLogin() {
            if (isAdminLoggedIn) showAdminDashboard();
            else document.getElementById('admin-login-modal').classList.remove('hidden');
        }
        function hideAdminLogin() { document.getElementById('admin-login-modal').classList.add('hidden'); }
        function checkAdminLogin() {
            if (document.getElementById('admin-pw').value === '8888') {
                isAdminLoggedIn = true;
                hideAdminLogin();
                showAdminDashboard();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }
        function showAdminDashboard() {
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('nav-dock').classList.add('hidden');
            document.getElementById('admin-screen').classList.remove('hidden');
            initMap();
        }
        function exitAdmin() {
            isAdminLoggedIn = false;
            document.getElementById('admin-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.remove('hidden');
            document.getElementById('nav-dock').classList.remove('hidden');
        }
        function renderAdminProducts() {
            const container = document.getElementById('admin-product-list');
            container.innerHTML = products.map(p => `
                <div class="flex items-center justify-between border-b border-stone-100 dark:border-stone-800 pb-10">
                    <div class="flex items-center gap-6">
                        <div class="w-20 h-20 rounded-3xl overflow-hidden border-2 border-sathu-gold shadow-lg">
                            <img src="${p.img}" class="object-cover h-full w-full">
                        </div>
                        <div><p class="font-bold text-xl">${p.name}</p><p class="text-[10px] text-stone-400 uppercase">ID: ${p.id}</p></div>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex flex-col gap-2">
                            <label class="text-[9px] uppercase font-bold text-stone-400">‡∏£‡∏≤‡∏Ñ‡∏≤</label>
                            <input type="number" id="price-${p.id}" value="${p.price}" class="w-16 h-12 bg-stone-100 dark:bg-stone-800 border-none rounded-xl text-center font-bold text-primary text-lg transition-theme">
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-[9px] uppercase font-bold text-stone-400">‡∏™‡∏ï‡πá‡∏≠‡∏Å</label>
                            <input type="number" id="stock-${p.id}" value="${p.stock}" class="w-16 h-12 bg-stone-100 dark:bg-stone-800 border-none rounded-xl text-center font-bold text-lg transition-theme">
                        </div>
                    </div>
                </div>
            `).join('') + '<button onclick="saveAdminData()" class="w-full bg-primary text-white py-6 rounded-full font-bold uppercase tracking-[0.3em] text-[12px] shadow-2xl shimmer">Update Database</button>';
        }

        async function saveAdminData() {
            if (!WEB_APP_URL) return alert("üî¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ WEB_APP_URL ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            
            const updatedProducts = products.map(p => ({
                id: p.id,
                price: document.getElementById(`price-${p.id}`).value,
                stock: document.getElementById(`stock-${p.id}`).value
            }));

            try {
                await callApi({ action: 'updateProducts', products: updatedProducts });
                showToast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                products.forEach((p, i) => {
                    p.price = updatedProducts[i].price;
                    p.stock = updatedProducts[i].stock;
                });
                renderUserProducts();
            } catch (e) {
                alert("Error: " + e);
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function switchAdminTab(tab) {
            document.getElementById('admin-stock').classList.toggle('hidden', tab !== 'stock');
            document.getElementById('admin-map').classList.toggle('hidden', tab !== 'map');
            document.getElementById('tab-stock').classList.toggle('admin-tab-active', tab === 'stock');
            document.getElementById('tab-map').classList.toggle('admin-tab-active', tab === 'map');
            if(tab === 'map') {
                setTimeout(() => map.invalidateSize(), 300);
                fetchDeliveryMarkers();
            }
        }

        function initMap() {
            if (map) return;
            map = L.map('delivery-map', { zoomControl: false }).setView([17.415, 102.786], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        async function fetchDeliveryMarkers() {
            // Mock fetching from DB
            const markers = [
                { lat: 17.416, lng: 102.787, name: '‡∏Ñ‡∏∏‡∏ì‡∏°‡∏á‡∏Ñ‡∏•', items: '‡∏ö‡∏±‡∏ß x2' },
                { lat: 17.420, lng: 102.780, name: '‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡∏™‡∏£‡∏±‡∏ä', items: '‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÑ‡∏°‡πâ x1' }
            ];
            markers.forEach(m => {
                L.marker([m.lat, m.lng]).addTo(map).bindPopup(`<b>${m.name}</b><br>${m.items}`);
            });
        }

        // --- API HANDLER ---
        async function callApi(payload, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    return await response.json();
                } catch (err) {
                    if (i === retries - 1) throw err;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        // --- SLIDE TO PAY ---
        const knob = document.getElementById('slider-knob');
        const container = document.getElementById('slide-container');
        let isDragging = false;
        let startX = 0;

        knob.addEventListener('mousedown', s => start(s));
        knob.addEventListener('touchstart', s => start(s));
        window.addEventListener('mousemove', m => move(m));
        window.addEventListener('touchmove', m => move(m));
        window.addEventListener('mouseup', () => end());
        window.addEventListener('touchend', () => end());

        function start(e) {
            isDragging = true;
            startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            knob.style.transition = 'none';
        }
        function move(e) {
            if (!isDragging) return;
            const x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const max = container.offsetWidth - knob.offsetWidth - 32;
            let delta = Math.max(0, Math.min(x - startX, max));
            knob.style.transform = `translateX(${delta}px)`;
            if (delta >= max * 0.98) {
                isDragging = false;
                submitOrder();
            }
        }
        function end() {
            if (!isDragging) return;
            isDragging = false;
            knob.style.transition = 'transform 0.5s cubic-bezier(0.19, 1, 0.22, 1)';
            knob.style.transform = `translateX(0px)`;
        }

        async function submitOrder() {
            if (!WEB_APP_URL) return alert("üî¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ WEB_APP_URL ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏°‡∏ñ‡∏ß‡∏≤‡∏¢‡πÄ‡∏à‡∏ï‡∏ô‡∏≤...";

            const orderData = {
                action: 'saveOrder',
                name: document.getElementById('cust-name').value,
                phone: document.getElementById('cust-phone').value,
                location: userLocation,
                prayer: document.getElementById('cust-prayer').value,
                items: Object.keys(cart).filter(id => cart[id] > 0).map(id => `${products.find(p=>p.id===id).name} x${cart[id]}`).join(', '),
                totalPrice: document.getElementById('final-total').innerText
            };

            try {
                const res = await callApi(orderData);
                if (res.success) {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('success-screen').classList.remove('hidden');
                } else throw new Error(res.message);
            } catch (e) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e);
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('toast-active');
            setTimeout(() => t.classList.remove('toast-active'), 3000);
        }

        init();
    </script>
</body>
</html>
