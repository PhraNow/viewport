<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SATHU - Sacred Materialism</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&family=Prompt:wght@300;400;500&family=Charm:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script>
        // =========================================================================
        // üî¥üî¥üî¥ CONFIGURATION üî¥üî¥üî¥
        // =========================================================================
        
        // 1. ‡∏ß‡∏≤‡∏á URL ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyfdU30cofQ7cH_JiQNQJXiWYB9ia6KiTo3y_wxjSMnkWidzslDq1nMaVq79PTNDgY0/exec"; 

        // 2. ID ‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (BG)
        const BG_HERO_ID = "1Q2q51p0NPisY_D9V1AWWZ60I3OHSqV-_";

        // 3. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏£‡∏≠‡∏á
        const FALLBACK_PRODUCTS = [
            { id: '1', name: '‡∏ä‡πà‡∏≠‡∏î‡∏≠‡∏Å‡∏ö‡∏±‡∏ß‡∏™‡∏î', desc: '‡∏Ñ‡∏±‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©', price: 10, img: '1yTbEv2lg8FU-_4jaXgV8yqpVt_71laKG' },
            { id: '2', name: '‡∏ä‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÑ‡∏°‡πâ‡∏™‡∏î', desc: '‡∏™‡∏î‡πÉ‡∏´‡∏°‡πà', price: 10, img: '1J1Eq279p2AO2nSI6MH4TZyXgkepQ6JkM' },
            { id: '3', name: '‡∏ä‡πà‡∏≠‡∏î‡∏≤‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏™‡∏î', desc: '‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á', price: 10, img: '1It1hrUdx69s_U3WPMHMB8IsLGdfJN8H0' },
            { id: '4', name: '‡∏û‡∏ß‡∏á‡∏°‡∏≤‡∏•‡∏±‡∏¢ (‡πÄ‡∏•‡πá‡∏Å)', desc: '2 ‡∏ä‡∏≤‡∏¢', price: 5, img: '18KkBoBHM_KgRMJBBmcLR4ChaH0ct23a8' },
            { id: '5', name: '‡∏û‡∏ß‡∏á‡∏°‡∏≤‡∏•‡∏±‡∏¢ (‡πÉ‡∏´‡∏ç‡πà)', desc: '2 ‡∏ä‡∏≤‡∏¢', price: 10, img: '18KkBoBHM_KgRMJBBmcLR4ChaH0ct23a8' },
            { id: '6', name: '‡∏û‡∏≤‡∏ô‡∏ö‡∏≤‡∏¢‡∏®‡∏£‡∏µ', desc: '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô', price: 0, img: '1BX929_N-i9_dQTFywCwqIG0_cxZVhbIa' }
        ];

        // =========================================================================

        tailwind.config = {
            theme: {
                extend: {
                    colors: { "primary": "#B91C1C", "dark": "#111111", "light": "#F9F9F9", "gold": "#D4AF37" },
                    fontFamily: { "sans": ["Inter", "Prompt", "sans-serif"], "serif": ["Playfair Display", "serif"], "logo": ["Charm", "serif"] },
                    boxShadow: { 'dock': '0 20px 40px -5px rgba(0,0,0,0.3)', 'card': '0 -15px 40px -10px rgba(0,0,0,0.1)' }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #000; font-family: 'Inter', sans-serif; overflow: hidden; display: flex; justify-content: center; }
        #app-frame { width: 100%; max-width: 430px; background-color: #1a1a1a; height: 100dvh; position: relative; overflow: hidden; box-shadow: 0 0 50px rgba(255,255,255,0.05); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        
        .slide-panel { 
            position: absolute; inset: 0; 
            transform: translateY(100%); 
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1); 
            z-index: 50; visibility: hidden; background-color: #F9F9F9;
        }
        .slide-panel.active { transform: translateY(0); visibility: visible; }

        /* Slider */
        .slide-track { position: relative; width: 100%; height: 60px; background: #F3F4F6; border-radius: 999px; display: flex; align-items: center; overflow: hidden; }
        .slide-text { position: absolute; width: 100%; text-align: center; font-size: 13px; font-weight: 600; letter-spacing: 2px; color: #9CA3AF; text-transform: uppercase; pointer-events: none; z-index: 1; }
        .slide-knob { position: absolute; left: 4px; width: 52px; height: 52px; background: #B91C1C; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; z-index: 2; cursor: grab; box-shadow: 0 4px 15px rgba(185, 28, 28, 0.4); transition: transform 0.1s linear; }
        .slide-fill { position: absolute; left: 0; top: 0; bottom: 0; background: rgba(185, 28, 28, 0.1); width: 0; z-index: 0; }
        .hero-mask { -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%); mask-image: linear-gradient(to bottom, black 60%, transparent 100%); }
    </style>
</head>
<body>

    <div id="app-frame">
        
        <!-- HOME SCREEN -->
        <div id="home-screen" class="relative w-full h-full bg-dark">
            <!-- Hero Background -->
            <div class="absolute inset-0 z-0 h-[85vh]">
                <img id="hero-bg" src="" 
                     class="w-full h-full object-cover opacity-80 scale-105 hero-mask transition-opacity duration-1000"
                     onerror="this.src='https://images.unsplash.com/photo-1617110825345-0373bb61352b?q=80&w=800'">
                <div class="absolute inset-0 bg-gradient-to-t from-dark via-transparent to-black/40"></div>
            </div>

            <!-- Header -->
            <div class="relative z-10 flex flex-col items-center pt-24 text-white text-center">
                <h1 class="font-logo text-7xl text-white drop-shadow-2xl mb-2 fade-in" style="animation-delay: 0.1s">‡∏™‡∏≤‡∏ò‡∏∏</h1>
                <p class="font-sans text-[10px] tracking-[0.5em] uppercase opacity-70 font-light fade-in" style="animation-delay: 0.2s">Digital Nirvana</p>
            </div>

            <!-- Quote -->
            <div class="absolute bottom-60 left-0 right-0 px-10 text-center z-10 fade-in" style="animation-delay: 0.4s">
                <p class="font-serif italic text-white/80 text-xl leading-relaxed font-light">
                    "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏®‡∏£‡∏±‡∏ó‡∏ò‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏™‡∏Ç‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á"
                </p>
            </div>

            <!-- Product Showcase -->
            <div class="absolute bottom-28 left-0 right-0 z-20 pl-6 fade-in" style="animation-delay: 0.6s">
                <div class="flex justify-between items-center pr-6 mb-4">
                    <h2 class="font-serif text-2xl font-bold text-white tracking-wide">Vessels of Light</h2>
                    <span class="text-white/60 text-[10px] font-sans tracking-widest uppercase">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ</span>
                </div>
                
                <div class="flex gap-4 overflow-x-auto no-scrollbar pb-6 pr-6" id="product-scroll">
                    <div class="flex items-center gap-2 text-white/50 text-sm h-[220px] pl-4">
                        <span class="animate-spin material-icons-round">sync</span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                    </div>
                </div>
            </div>

            <!-- üü¢üü¢üü¢ Bottom Dock (5 Menus) üü¢üü¢üü¢ -->
            <div class="absolute bottom-8 left-0 right-0 flex justify-center z-30">
                <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-full h-16 shadow-dock flex items-center justify-between px-6 gap-2 w-[90%] max-w-[360px]">
                    
                    <!-- 1. Home -->
                    <button class="text-white p-2" onclick="window.location.reload()">
                        <span class="material-icons-round text-2xl">home</span>
                    </button>
                    
                    <!-- 2. Map (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô) -->
                    <button class="text-white/50 hover:text-white transition-colors p-2" onclick="window.location.href='map.html'" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô">
                        <span class="material-icons-round text-2xl">map</span>
                    </button>
                    
                    <!-- 3. Cart (‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á) -->
                    <button class="text-white/50 hover:text-white transition-colors relative p-2" onclick="openCheckout()">
                        <span class="material-icons-round text-3xl">shopping_bag</span>
                        <div id="cart-dot" class="hidden absolute top-2 right-1 w-2.5 h-2.5 bg-primary border border-white rounded-full shadow-glow"></div>
                    </button>
                    
                    <!-- 4. Partner (‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡πâ‡∏≤‡∏ô) -->
                    <button class="text-white/50 hover:text-white transition-colors p-2" onclick="window.location.href='partner.html'" title="‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ô‡∏≠‡∏£‡πå">
                        <span class="material-icons-round text-2xl">storefront</span>
                    </button>
                    
                    <!-- 5. Admin (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ) -->
                    <button onclick="toggleAdminLogin()" class="text-white/50 hover:text-white transition-colors p-2">
                        <span class="material-icons-round text-2xl">person</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- CHECKOUT SHEET -->
        <div id="checkout-sheet" class="slide-panel flex flex-col bg-[#F9F9F9]">
            <div class="px-6 pt-14 pb-4 bg-white sticky top-0 z-20 shadow-sm flex items-center justify-between border-b border-gray-50">
                <button onclick="closeCheckout()" class="w-10 h-10 -ml-2 rounded-full flex items-center justify-center text-gray-800 hover:bg-gray-50 transition-colors">
                    <span class="material-icons-round text-2xl">keyboard_arrow_down</span>
                </button>
                <h2 class="font-sans font-bold text-lg text-gray-900">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
                <div class="w-8"></div>
            </div>

            <div class="flex-1 overflow-y-auto px-6 pt-6 pb-40 space-y-8 bg-white">
                <div id="cart-list" class="space-y-6"></div>

                <div class="space-y-5 pt-4 border-t border-dashed border-gray-200">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest pl-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h3>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <label class="p-3 bg-[#F8F8F8] rounded-2xl border border-gray-100 flex flex-col items-center justify-center cursor-pointer hover:border-primary/30 transition-colors">
                            <input type="radio" name="timeslot" value="‡πÄ‡∏ä‡πâ‡∏≤ 07:00-09:00" class="peer sr-only" checked>
                            <span class="material-icons-round text-orange-400 peer-checked:text-primary mb-1">wb_sunny</span>
                            <span class="text-xs font-bold text-gray-600 peer-checked:text-primary">‡∏£‡∏≠‡∏ö‡πÄ‡∏ä‡πâ‡∏≤</span>
                        </label>
                        <label class="p-3 bg-[#F8F8F8] rounded-2xl border border-gray-100 flex flex-col items-center justify-center cursor-pointer hover:border-primary/30 transition-colors">
                            <input type="radio" name="timeslot" value="‡πÄ‡∏¢‡πá‡∏ô 16:00-18:00" class="peer sr-only">
                            <span class="material-icons-round text-indigo-400 peer-checked:text-primary mb-1">nights_stay</span>
                            <span class="text-xs font-bold text-gray-600 peer-checked:text-primary">‡∏£‡∏≠‡∏ö‡πÄ‡∏¢‡πá‡∏ô</span>
                        </label>
                    </div>

                    <div onclick="getLocation()" class="flex items-center gap-4 p-4 bg-[#F8F8F8] rounded-2xl border border-gray-100 cursor-pointer active:scale-[0.98] transition-transform">
                        <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center text-primary shrink-0"><span class="material-icons-round text-xl">near_me</span></div>
                        <div class="flex-1 min-w-0">
                            <p class="text-[10px] font-bold text-primary tracking-widest uppercase mb-0.5">‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</p>
                            <p class="text-sm font-bold text-gray-800 truncate" id="location-text">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</p>
                        </div>
                        <span class="material-icons-round text-gray-300">chevron_right</span>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <input id="inp-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" class="bg-[#F8F8F8] border-none rounded-2xl px-5 py-4 text-sm font-bold text-gray-800 outline-none focus:ring-1 focus:ring-primary/20">
                        <input id="inp-phone" type="tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="bg-[#F8F8F8] border-none rounded-2xl px-5 py-4 text-sm font-bold text-gray-800 outline-none focus:ring-1 focus:ring-primary/20">
                    </div>
                    <textarea id="inp-address" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏£‡∏±‡πâ‡∏ß‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß, ‡∏ù‡∏≤‡∏Å‡∏õ‡πâ‡∏≠‡∏°‡∏¢‡∏≤‡∏°)" class="w-full bg-[#F8F8F8] border-none rounded-2xl px-5 py-4 text-sm font-bold text-gray-800 outline-none focus:ring-1 focus:ring-primary/20 h-24 resize-none"></textarea>
                </div>

                <div class="space-y-2">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest pl-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏à‡∏¥‡∏ï</h3>
                    <textarea id="inp-prayer" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô..." class="w-full bg-[#F8F8F8] border-none rounded-2xl px-5 py-4 text-base italic font-serif text-gray-600 outline-none focus:ring-1 focus:ring-primary/20 h-28 resize-none shadow-inner"></textarea>
                </div>

                <div class="p-6 bg-[#FAFAFA] rounded-2xl text-center border border-gray-100">
                    <div class="mb-4 inline-block bg-white p-2 rounded-xl shadow-sm">
                        <img src="https://promptpay.io/0847936665.png" class="w-24 h-24 mix-blend-multiply opacity-90">
                    </div>
                    <p class="text-xl font-bold text-gray-900 tracking-wider mb-1">084-793-6665</p>
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-4">‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡∏™‡∏£‡∏±‡∏ä ‡∏™‡∏∏‡∏à‡∏≤‡∏£‡∏µ</p>
                    <button onclick="document.getElementById('inp-slip').click()" class="w-full py-3 rounded-xl border border-dashed border-gray-300 text-xs font-bold text-gray-500 hover:text-primary hover:border-primary/50 transition-colors flex items-center justify-center gap-2 group">
                        <span class="material-icons-round text-lg group-hover:text-primary">cloud_upload</span> <span id="slip-text">‡∏Å‡∏î‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                    </button>
                    <input type="file" id="inp-slip" class="hidden" accept="image/*" onchange="handleSlip()">
                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-6 pt-4 pb-10 z-20 rounded-t-[2.5rem] shadow-card">
                <div class="flex justify-between items-end mb-6 px-1">
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                        <p class="text-3xl font-serif font-bold text-gray-900" id="checkout-total">‡∏ø0.00</p>
                    </div>
                    <div class="flex items-center gap-1.5 opacity-80">
                        <span class="material-icons-round text-primary text-sm">verified_user</span>
                        <span class="text-[10px] font-bold text-primary tracking-wider">SECURED</span>
                    </div>
                </div>
                <div class="slide-track" id="slider-container">
                    <div class="slide-fill" id="slider-fill"></div>
                    <div class="slide-text">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏ß‡∏≤‡∏¢‡∏ö‡∏∏‡∏ç</div>
                    <div class="slide-knob" id="slider-knob"><span class="material-icons-round text-white text-xl">keyboard_double_arrow_right</span></div>
                </div>
            </div>
        </div>

        <!-- SUCCESS OVERLAY -->
        <div id="success-overlay" class="absolute inset-0 z-[60] bg-white hidden flex-col items-center justify-center text-center p-10 fade-in">
            <div class="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mb-8 shadow-sm">
                <span class="material-icons-round text-green-600 text-4xl">check</span>
            </div>
            <h2 class="font-serif text-3xl font-bold text-gray-900 mb-4">Anumodana</h2>
            <p class="text-sm text-gray-500 mb-12 max-w-xs mx-auto leading-relaxed">‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß<br>‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏ö‡∏∏‡∏ç‡∏™‡πà‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏à‡∏£‡∏¥‡∏ç</p>
            <button onclick="window.location.reload()" class="bg-gray-900 text-white px-12 py-3.5 rounded-full text-xs font-bold tracking-widest uppercase shadow-lg active:scale-95 transition-transform">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </div>

        <div id="loading-overlay" class="absolute inset-0 z-[70] bg-white/80 backdrop-blur-sm hidden flex-col items-center justify-center">
            <div class="w-10 h-10 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-4"></div>
            <p class="text-xs font-bold text-primary tracking-widest uppercase animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 bg-dark/90 backdrop-blur text-white px-6 py-3 rounded-full text-xs font-bold shadow-xl z-[80] transition-all duration-300 -translate-y-24 opacity-0 pointer-events-none">Notification</div>

    </div>

    <script>
        let products = [];
        let cart = {};
        let userLocation = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('hero-bg').src = `https://drive.google.com/thumbnail?id=${BG_HERO_ID}&sz=w1200`;
            initSlider();
            
            if(WEB_APP_URL && WEB_APP_URL.includes('/exec')) fetchProducts();
            else {
                products = FALLBACK_PRODUCTS;
                renderHomeProducts();
            }
        });

        function getImgUrl(id) { return `https://drive.google.com/thumbnail?id=${id}&sz=w600`; }

        async function fetchProducts() {
            try {
                if(!WEB_APP_URL) throw new Error("No URL");
                const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'getProducts' }) });
                const data = await res.json();
                if(data.success && data.products.length > 0) {
                    products = data.products.map(p => ({ ...p, img: p.imgId || p.img }));
                    renderHomeProducts();
                } else throw new Error("No data");
            } catch(e) {
                products = FALLBACK_PRODUCTS; 
                renderHomeProducts();
            }
        }

        function renderHomeProducts() {
            const container = document.getElementById('product-scroll');
            container.innerHTML = products.map(p => {
                const isContact = p.price == 0;
                return `
                <div class="min-w-[160px] relative group cursor-pointer active:scale-95 transition-transform" onclick="${isContact ? `contactLine()` : `addToCart('${p.id}')`}">
                    <div class="h-[220px] w-full rounded-[24px] overflow-hidden bg-white shadow-lg relative border border-white/10">
                        <img src="${getImgUrl(p.img)}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" onerror="this.src='https://placehold.co/200x300?text=No+Image'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                        <div class="absolute bottom-5 left-5 text-white">
                            <p class="font-serif text-xl leading-none mb-1 font-medium">${p.name}</p>
                            <p class="text-[10px] opacity-80 uppercase tracking-widest font-sans">${isContact ? '‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤' : '‡∏ø' + p.price}</p>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function renderCartItems() {
            const container = document.getElementById('cart-list');
            const items = products.filter(p => cart[p.id] > 0);
            
            if (items.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-400 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
                return;
            }

            container.innerHTML = items.map(p => `
                <div class="flex items-center gap-5">
                    <div class="w-20 h-20 rounded-2xl bg-gray-100 overflow-hidden shrink-0 shadow-sm">
                        <img src="${getImgUrl(p.img)}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-base text-gray-900 font-serif">${p.name}</p>
                        <p class="text-[10px] text-gray-400 uppercase tracking-wider mb-2">${p.desc || 'Premium'}</p>
                        <p class="text-sm font-bold text-primary">‡∏ø${p.price}</p>
                    </div>
                    <div class="flex items-center gap-3 bg-white border border-gray-100 rounded-full p-1 px-2 h-10 shadow-sm">
                        <button onclick="updateQty('${p.id}', -1)" class="w-8 h-8 flex items-center justify-center text-gray-400 active:scale-90">-</button>
                        <span class="text-sm font-bold w-4 text-center text-gray-900">${cart[p.id]}</span>
                        <button onclick="updateQty('${p.id}', 1)" class="w-8 h-8 flex items-center justify-center text-primary active:scale-90">+</button>
                    </div>
                </div>
            `).join('');
        }

        function addToCart(id) {
            cart[id] = (cart[id] || 0) + 1;
            updateTotal();
            showToast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
            openCheckout();
        }
        
        function contactLine() {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ");
        }

        function updateQty(id, delta) {
            cart[id] = Math.max(0, (cart[id] || 0) + delta);
            renderCartItems();
            updateTotal();
        }

        function updateTotal() {
            let total = 0, count = 0;
            products.forEach(p => {
                if(cart[p.id]) {
                    total += cart[p.id] * p.price;
                    count += cart[p.id];
                }
            });
            document.getElementById('checkout-total').innerText = `‡∏ø${total.toFixed(2)}`;
            const badge = document.getElementById('cart-dot');
            if(count > 0) badge.classList.remove('hidden');
            else badge.classList.add('hidden');
        }

        function openCheckout() {
            renderCartItems();
            document.getElementById('checkout-sheet').classList.add('active');
        }

        function closeCheckout() {
            document.getElementById('checkout-sheet').classList.remove('active');
        }

        function getLocation() {
            document.getElementById('location-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        userLocation = `${pos.coords.latitude}, ${pos.coords.longitude}`;
                        document.getElementById('location-text').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß";
                        document.getElementById('location-text').classList.add('text-green-600');
                    },
                    () => {
                        document.getElementById('location-text').innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á GPS";
                    }
                );
            }
        }

        function copyBank() {
            navigator.clipboard.writeText("0847936665");
            showToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
        }

        function handleSlip() {
            document.getElementById('slip-text').innerText = "‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
            document.getElementById('slip-text').classList.add('text-primary');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            t.style.transform = 'translate(-50%, 0)';
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translate(-50%, -20px)';
            }, 2000);
        }

        function initSlider() {
            const container = document.querySelector('.slider-container');
            const knob = document.querySelector('.slider-knob');
            const fill = document.querySelector('.slider-track-fill');
            let isDragging = false;
            let startX;

            const start = (e) => {
                isDragging = true;
                startX = e.touches ? e.touches[0].clientX : e.clientX;
                knob.style.transition = 'none';
            };

            const move = (e) => {
                if (!isDragging) return;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const max = container.clientWidth - knob.offsetWidth - 8;
                let delta = Math.min(Math.max(0, clientX - startX), max);
                knob.style.transform = `translateX(${delta}px)`;
                fill.style.width = `${delta + 28}px`;

                if (delta >= max * 0.95) {
                    isDragging = false;
                    knob.style.transform = `translateX(${max}px)`;
                    submitOrder();
                }
            };

            const end = () => {
                if (!isDragging) return;
                isDragging = false;
                knob.style.transition = 'transform 0.3s';
                knob.style.transform = 'translateX(0)';
                fill.style.width = '0';
            };

            knob.addEventListener('mousedown', start);
            knob.addEventListener('touchstart', start);
            window.addEventListener('mousemove', move);
            window.addEventListener('touchmove', move);
            window.addEventListener('mouseup', end);
            window.addEventListener('touchend', end);
        }

        async function submitOrder() {
            const totalStr = document.getElementById('checkout-total').innerText;
            if(totalStr === '‡∏ø0.00') {
                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
                resetSlider(); return;
            }
            if(!document.getElementById('inp-name').value || !document.getElementById('inp-phone').value) {
                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
                resetSlider(); return;
            }
            
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-overlay').classList.add('flex');

            const name = document.getElementById('inp-name').value;
            const items = products.filter(p => cart[p.id] > 0).map(p => `${p.name} x${cart[p.id]}`).join(', ');
            const timeSlot = document.querySelector('input[name="timeslot"]:checked').value;
            const slipFile = document.getElementById('inp-slip').files[0];

            const payload = {
                action: 'saveOrder',
                name: name,
                phone: document.getElementById('inp-phone').value,
                address: document.getElementById('inp-address').value,
                prayer: document.getElementById('inp-prayer').value,
                items: items,
                totalPrice: totalStr,
                location: userLocation,
                timeSlot: timeSlot,
                slipImage: null
            };

            if (slipFile) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    payload.slipImage = e.target.result;
                    await sendData(payload);
                };
                reader.readAsDataURL(slipFile);
            } else {
                await sendData(payload);
            }
        }

        async function sendData(payload) {
            if(WEB_APP_URL) {
                try {
                    await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
                } catch(e) {}
            } else {
                await new Promise(r => setTimeout(r, 1500)); 
            }
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('checkout-sheet').classList.remove('active');
            document.getElementById('success-overlay').classList.remove('hidden');
            document.getElementById('success-overlay').classList.add('flex');
            resetSlider();
        }

        function resetSlider() {
            document.querySelector('.slider-knob').style.transform = 'translateX(0)';
            document.querySelector('.slider-track-fill').style.width = '0';
        }
        
        function toggleAdminLogin() {
            const pw = prompt("Admin Password:");
            if(pw === "8888") alert("Admin Mode (Management System Coming Soon)");
        }
    </script>
</body>
</html>
